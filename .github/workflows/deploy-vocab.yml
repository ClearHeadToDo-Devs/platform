name: Deploy Vocabulary Site

on:
  push:
    branches: [main]
    paths:
      - 'ontology/**'
      - '.github/workflows/deploy-vocab.yml'
  pull_request:
    branches: [main]
    paths:
      - 'ontology/**'

jobs:
  validate:
    name: Validate Ontology
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ontology

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install

      - name: Install dependencies
        run: uv sync

      - name: Validate ontology syntax
        run: uv run invoke validate

      - name: Run SHACL validation tests
        run: uv run invoke test

      - name: Test example instances
        run: uv run pytest tests/v3/test_example_validation.py -v

      - name: Upload validation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-results
          path: |
            ontology/schemas/
            ontology/test-results/

  build-site:
    name: Build Vocabulary Site
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install uv
        uses: astral-sh/setup-uv@v3

      - name: Set up Python
        run: uv python install
        working-directory: ./ontology

      - name: Install dependencies
        run: uv sync
        working-directory: ./ontology

      - name: Generate schemas and build site
        run: |
          cd ontology
          uv run invoke generate-schemas
          uv run invoke build-site

      - name: Validate site structure
        run: |
          echo "üîç Validating deployment structure..."

          # The site is already built in ontology/site/
          # Check required files exist
          test -f ontology/site/vocab/actions/v3/actions-vocabulary.owl || { echo "‚ùå Missing OWL file"; exit 1; }
          test -f ontology/site/vocab/actions/v3/actions-vocabulary.ttl || { echo "‚ùå Missing TTL file"; exit 1; }
          test -f ontology/site/vocab/actions/v3/shapes.ttl || { echo "‚ùå Missing shapes"; exit 1; }
          test -f ontology/site/index.html || { echo "‚ùå Missing main index"; exit 1; }
          test -f ontology/site/vocab/actions/examples/index.html || { echo "‚ùå Missing examples index"; exit 1; }
          test -d ontology/site/vocab/actions/examples/ttl || { echo "‚ùå Missing examples TTL directory"; exit 1; }

          echo "‚úÖ Site structure validated"

          # Show structure
          echo "üìÅ Deployment structure:"
          find ontology/site -type f | head -30

      - name: Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: vocabulary-site
          path: ontology/site/
          retention-days: 30

  deploy-cloudflare:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: build-site
    if: github.ref == 'refs/heads/main'

    environment:
      name: production
      url: https://clearhead.us/vocab/actions/v3/

    steps:
      - name: Download site artifact
        uses: actions/download-artifact@v4
        with:
          name: vocabulary-site
          path: ./site

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy site --project-name=actions-vocabulary --branch=main

      - name: Deployment summary
        run: |
          echo "‚úÖ Deployed to Cloudflare Pages"
          echo "üåê Production URL: https://clearhead.us/vocab/actions/v3/"
          echo "üì¶ Pages URL: https://actions-vocabulary.pages.dev"
          echo "üìö Examples: https://clearhead.us/vocab/actions/examples/"

  deploy-github-pages:
    name: Deploy to GitHub Pages (Backup)
    runs-on: ubuntu-latest
    needs: build-site
    if: github.ref == 'refs/heads/main' && false  # Disabled by default, enable if needed

    # Grant GITHUB_TOKEN permissions for Pages deployment
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download site artifact
        uses: actions/download-artifact@v4
        with:
          name: vocabulary-site
          path: ./site

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-cloudflare]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: Notify success
        if: needs.deploy-cloudflare.result == 'success'
        run: |
          echo "üéâ Vocabulary site deployed successfully to Cloudflare!"
          echo "üåê Production URL: https://clearhead.us/vocab/actions/v3/"
          echo "üì¶ Pages URL: https://actions-vocabulary.pages.dev"
          echo "üìö Examples: https://clearhead.us/vocab/actions/examples/"

      - name: Notify failure
        if: needs.deploy-cloudflare.result == 'failure'
        run: |
          echo "‚ùå Cloudflare deployment failed!"
          echo "üí° Check secrets: CLOUDFLARE_API_TOKEN, CLOUDFLARE_ACCOUNT_ID"
          exit 1
